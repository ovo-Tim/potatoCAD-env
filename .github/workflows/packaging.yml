name: packaging

on:
  pull_request:
    branches:
      - master
  workflow_dispatch:
    branches:
      - master

jobs:
  mambaforge:
    name: mambaforge (${{ matrix.os }}, Mambaforge)
    runs-on: ${{ matrix.os }}-latest
    strategy:
      fail-fast: false
      matrix:
        os: ["ubuntu", "macos", "windows"]
        include:
          - os: ubuntu
            miniforge-variant: Mambaforge
          - os: macos
            miniforge-variant: Mambaforge
          - os: windows
            miniforge-variant: Mambaforge
    steps:
      - name: Checkout master
        uses: actions/checkout@v2
        with:
          ref: main
      - uses: conda-incubator/setup-miniconda@v2
        with:
          condarc-file: ${{ matrix.condarc-file }}
          miniforge-variant: ${{ matrix.miniforge-variant }}
          miniforge-version: ${{ matrix.miniforge-version }}
          use-mamba: true
      - name: Env
        run: |
          mamba create -n potatoCAD python=3.8
          conda init
      - name: Env-linux
        if: matrix.os == 'ubuntu'
        run: |
          source /home/runner/.bashrc
      - name: Env-mac
        if: matrix.os == 'macos'
        run: |
          source /Users/runner/.bash_profile

      - name: Install dependencies
        run: |
          conda activate potatoCAD
          python -m pip install --upgrade pip
          pip install -r ./requirements-pip.txt
          mamba install --yes --file ./requirements-conda.txt 
          mamba install -c conda-forge conda-pack
          conda pack -n potatoCAD -o environment-${{ matrix.os }}.zip --zip-symlinks
      - name: Create Release
        uses: GoogleCloudPlatform/release-please-action@v3
        id: release
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: node
          package-name: testing-version
          asset-path: ./environment-${{ matrix.os }}.zip
          # changelog-types: '[{"type": "types", "section":"Types", "hidden": false},{"type": "revert", "section":"Reverts", "hidden": false},{"type": "feat", "section": "Features", "hidden": false},{"type": "fix", "section": "Bug Fixes", "hidden": false},{"type": "improvement", "section": "Feature Improvements", "hidden": false},{"type": "docs", "section":"Docs", "hidden": false},{"type": "style", "section":"Styling", "hidden": false},{"type": "refactor", "section":"Code Refactoring", "hidden": false},{"type": "perf", "section":"Performance Improvements", "hidden": false},{"type": "test", "section":"Tests", "hidden": false},{"type": "build", "section":"Build System", "hidden": false},{"type": "ci", "section":"CI", "hidden":false}]'
      - uses: actions/checkout@v2